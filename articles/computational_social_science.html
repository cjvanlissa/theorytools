<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Conducting Theory-Based Reproducible Simulation Studies • theorytools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Conducting Theory-Based Reproducible Simulation Studies">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">theorytools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/augmented_dags.html">Specifying Augmented Directed Acyclic Graphs</a></li>
    <li><a class="dropdown-item" href="../articles/causal-inference.html">Using FAIR Theory for Causal Inference</a></li>
    <li><a class="dropdown-item" href="../articles/computational_social_science.html">Conducting Theory-Based Reproducible Simulation Studies</a></li>
    <li><a class="dropdown-item" href="../articles/dunning-kruger.html">FAIRifying the Dunning-Kruger Effect</a></li>
    <li><a class="dropdown-item" href="../articles/fair-theory.html">Making a Theory FAIR</a></li>
    <li><a class="dropdown-item" href="../articles/formalizing_sdt.html">Formalizing Self-Determination Theory</a></li>
    <li><a class="dropdown-item" href="../articles/readme.html">What to Include in a README?</a></li>
    <li><a class="dropdown-item" href="../articles/updating_theory.html">Updating a Theory</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Conducting Theory-Based Reproducible Simulation Studies</h1>
            
      

      <div class="d-none name"><code>computational_social_science.Rmd</code></div>
    </div>

    
    
<p>This tutorial introduces a reproducible research workflow for
computational social science studies, based on the <a href="https://github.com/cjvanlissa/worcs" class="external-link">Workflow for Open
Reproducible Code in Science (WORCS)</a>.</p>
<p>The WORCS workflow, implemented in the <code>worcs</code> package, is
designed to create fully reproducible research archives in R. The
<code>theorytools</code> R-package is designed to make and work with
<em>FAIR theories</em>: theories that are Findable in standardized
archives (Zenodo, Open Science Framework), Accessible using human- and
machine-readable file formats, Interoperable for specific purposes (in
this case, conducting computational simulation studies), and Reusable
(licensed to be iteratively updated, including by others than the
original author).</p>
<p>In this tutorial, we combine <code>worcs</code> and
<code>theorytools</code> to conduct a fully reproducible, theory-driven
computational simulation study.</p>
<div class="section level4">
<h4 id="before-starting-this-tutorial">Before Starting This Tutorial<a class="anchor" aria-label="anchor" href="#before-starting-this-tutorial"></a>
</h4>
<ul class="task-list">
<li><label><input type="checkbox">You must have <a href="https://cjvanlissa.github.io/worcs/articles/setup" class="external-link">Set up your
computer for WORCS</a></label></li>
<li><label><input type="checkbox">Running
<code><a href="https://cjvanlissa.github.io/worcs/reference/check_worcs_installation.html" class="external-link">worcs::check_worcs_installation()</a></code> should return all green
checkmarks</label></li>
</ul>
</div>
<div class="section level4">
<h4 id="learning-goals">Learning Goals<a class="anchor" aria-label="anchor" href="#learning-goals"></a>
</h4>
<p>In this tutorial, you will learn how to:</p>
<ul class="task-list">
<li><label><input type="checkbox">Create a reproducible research
project using WORCS.</label></li>
<li><label><input type="checkbox">Import a “FAIR theory”, specified as
an augmented DAG.</label></li>
<li><label><input type="checkbox">Create a computational simulation
study based on the FAIR theory.</label></li>
<li><label><input type="checkbox">Add <code>targets</code> to your
simulation study to reduce redundant compute</label></li>
<li><label><input type="checkbox">Add integration testing to your
study to ensure your functions work as intended</label></li>
</ul>
</div>
<div class="section level2">
<h2 id="setting-up-a-reproducible-project-with-worcs">Setting up a Reproducible Project with WORCS<a class="anchor" aria-label="anchor" href="#setting-up-a-reproducible-project-with-worcs"></a>
</h2>
<div class="section level3">
<h3 id="create-a-new-worcs-project">1. Create a new WORCS Project<a class="anchor" aria-label="anchor" href="#create-a-new-worcs-project"></a>
</h3>
<p>WORCS helps automate reproducible workflows by setting up version
control, metadata, licenses, and more.</p>
<ol style="list-style-type: decimal">
<li>Open RStudio.</li>
<li>Go to <strong>File &gt; New Project &gt; New Directory &gt; WORCS
Project Template</strong>.
<ol style="list-style-type: lower-alpha">
<li>Choose a directory name, e.g.,
<code>"fair_theory_simulation"</code>.</li>
<li>
<em>Optionally</em>, you can create a GitHub repository. If you have
GitHub integration set up, all that is required is to specify a GitHub
remote repository name.</li>
<li>Keep Manuscript template set to “GitHub document”</li>
<li>Keep Preregistration template set to “None”</li>
<li>Keep License set to “cc0” for a CC-0 copyright waiver</li>
<li>Select “Use renv”</li>
<li>
<strong>De-select</strong> “Use targets”: we will use
<code>targets</code> in the next chapter, but we’ll add support for it
manually for didactic purposes. Once you’re familiar with the
<code>targets</code> workflow, feel free to add it automatically when
creating your next project.</li>
<li>Select “Open in new session”</li>
</ol>
</li>
<li>Click <strong>Create Project</strong>.</li>
</ol>
<p>WORCS will now set up a project that implements best practices for
reproducibility. A new Rstudio instance should open automatically.</p>
<p>When working through the next sections, add the code chunks to your
<code>"manuscript.Rmd"</code> file except when the code is labeled with
<strong>Interactive:</strong>. Code labeled with
<strong>Interactive:</strong> should be run only once, in the Console
window. All other code can be inserted in code chunks in your
<code>"manuscript.Rmd"</code> file; knit it regularly to verify that
everything runs as expected.</p>
<blockquote>
<p>What does it mean to run R code <em>interactively</em>?
<select class="webex-select"><option value="blank"></option>
<option value="answer">Executing
code immediately in an R session that a human user is interacting
with.</option>
<option value="">Evaluating code by placing it in an
Rmarkdown document, and knitting that
document.</option>
<option value="">Having one function call another
function; these functions are said to be
‘interacting’</option></select></p>
</blockquote>
</div>
<div class="section level3">
<h3 id="download-a-fair-theory">2. Download a FAIR Theory<a class="anchor" aria-label="anchor" href="#download-a-fair-theory"></a>
</h3>
<p><strong>Interactive:</strong> You’ll need to install some packages to
run this tutorial. Run this code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"theorytools"</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"dagitty"</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"tidySEM"</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>To your <code>"manuscript.Rmd"</code> file, add the following lines
in the setup chunk:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cjvanlissa.github.io/theorytools/">theorytools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dagitty.net" class="external-link">dagitty</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cjvanlissa.github.io/tidySEM/" class="external-link">tidySEM</a></span><span class="op">)</span></span></code></pre></div>
<p>We will use a FAIR version of <strong>Self-Determination Theory
(SDT)</strong>. The vignette <a href="https://cjvanlissa.github.io/theorytools/articles/formalizing_sdt.html">Formalizing
Self-Determination Theory</a> describes how this FAIR theory was created
based on the original Self-Determination Theory <span class="citation">(Deci and Ryan 2012)</span>. It was specified as a
Directed Acyclic Graph, or DAG: a diagram that specifies the causal
relations proposed by a theory. Such diagrams can be used to derive
hypotheses, select control variables for causal inference, and conduct
simulation studies (as we will do in this tutorial).</p>
<p><strong>Interactive:</strong> Run the code below to download this
existing FAIR theory, which is stored on Zenodo. It will create a new
subfolder called <code>"theory/"</code> for these files, because the
theory repository has its own README and LICENSE files; you don’t want
to overwrite those files from your WORCS repository. Optionally, you can
have a look at the archived version by opening the URL <a href="https://doi.org/10.5281/zenodo.15648655" class="external-link uri">https://doi.org/10.5281/zenodo.15648655</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">theorytools</span><span class="fu">::</span><span class="fu"><a href="../reference/download_theory.html">download_theory</a></span><span class="op">(</span><span class="st">"10.5281/zenodo.15648655"</span>, path <span class="op">=</span> <span class="st">"theory"</span><span class="op">)</span></span></code></pre></div>
<p>The theory includes a README file, describing the contents of the
other files, a LICENSE describing how the theory can be reused, a file
called <code>sdt.txt</code> containing the DAG, and
<code>definitions.csv</code>, containing construct definitions. Note
that these definitions require further specification; as explained <a href="https://cjvanlissa.github.io/theorytools/articles/formalizing_sdt.html">in
the Vignette on formalizing SDT</a>), the book chapter describing the
theory does not explicitly define any of the constructs involved.</p>
<blockquote>
<p>Why is the FAIR theory downloaded into a separate
<code>theory/</code> subfolder?
<select class="webex-select"><option value="blank"></option>
<option value="">Because
theorytools only works inside a ‘theory/’
directory</option>
<option value="answer">To prevent overwriting the
WORCS project’s README and LICENSE files</option>
<option value="">To
avoid downloading unnecessary files</option>
<option value="">Because
dagitty requires theory files to be placed in a specific
folder</option></select></p>
</blockquote>
</div>
<div class="section level3">
<h3 id="load-the-fair-theory">3. Load the FAIR Theory<a class="anchor" aria-label="anchor" href="#load-the-fair-theory"></a>
</h3>
<p>This FAIR theory is an augmented DAG, which can be read using the
<code>dagitty</code> package.</p>
<p>The vignette <a href="https://cjvanlissa.github.io/theorytools/articles/augmented_dags.html">Specifying
Augmented Directed Acyclic Graphs</a> describes what augmented DAGs
are.</p>
<p>Such DAGs are particularly useful for computational social science
studies, because the <code>theorytools</code> package contains methods
to convert augmented DAGs to generative models.</p>
<p>Now, let’s load the augmented DAG. <strong>Note:</strong> when
running this code from a code chunk in your Rmarkdown file, you must use
the file path <code>../theory/sdt.txt</code> to go back to the parent
directory, because the manuscript and the theory are both in different
subdirectories. If you run it interactively instead, you are already
inside the parent directory, and you can use the path
<code>theory/sdt.txt</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdt</span> <span class="op">&lt;-</span> <span class="fu">dagitty</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/dagitty/man/dagitty.html" class="external-link">dagitty</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="st">"../theory/sdt.txt"</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then, we can plot the model using the tidySEM package. Get a basic
plot by running <code>graph_sem(sdt)</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tidySEM</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/tidySEM/reference/graph_sem.html" class="external-link">graph_sem</a></span><span class="op">(</span><span class="va">sdt</span><span class="op">)</span></span></code></pre></div>
<p><img src="sdt.png" width="60%"></p>
<blockquote>
<p>According to the DAG, what are the causes of <code>wellbeing</code>?
<select class="webex-select"><option value="blank"></option>
<option value="">needs,
intrinsic_ _motivation</option>
<option value="answer">integration,
intrinsic_motivation, needs</option>
<option value="">integration,
intrinsic_motivation</option></select></p>
</blockquote>
</div>
<div class="section level3">
<h3 id="creating-a-computational-model">4. Creating a Computational Model<a class="anchor" aria-label="anchor" href="#creating-a-computational-model"></a>
</h3>
<p>Computational simulation studies allow us to generate and analyze
simulated datasets, for example to:</p>
<ul>
<li>Explore what-if scenarios</li>
<li>Test the implications of model assumptions</li>
<li>Plan our analyses before data collection</li>
<li>Conduct power analysis and plan our sample size</li>
<li>Preregister a fully reproducible analysis pipeline <span class="citation">(Preregistration-As-Code, Peikert, Van Lissa, and
Brandmaier 2021; Van Lissa 2022)</span>.</li>
</ul>
<p>Below is a simple code snippet to generate synthetic data using the
<code><a href="../reference/simulate_data.html">theorytools::simulate_data()</a></code> function. This function
samples random values for exogenous variables and computes endogenous
variables as functions of their predictors (linear functions, by
default). By default, regression coefficients are randomly sampled in
the range <code>[-0.6, +0.6]</code> unless specific values are provided
by the user. You might use prior studies or expert knowledge to set more
realistic parameter values, or use the conventional values for null (0),
small (.2), or medium (.4) effect sizes. By default, normal
distributions are assumed for exogenous variables and residual error,
unless other distributions are specified. Note that many other functions
for simulating data exist, and some may be better suited to particular
use cases. The tutorial on <a href="https://cjvanlissa.github.io/theorytools/articles/augmented_dags.html">Specifying
Augmented DAGS</a> contains more information about user-defined
functional forms and (error) distributions.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">theorytools</span><span class="fu">::</span><span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span><span class="va">sdt</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<table style="width:100%;" class="table">
<colgroup>
<col width="14%">
<col width="19%">
<col width="11%">
<col width="20%">
<col width="18%">
<col width="5%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th align="right">external_event</th>
<th align="right">healthy_development</th>
<th align="right">integration</th>
<th align="right">intrinsic_motivation</th>
<th align="right">locus_of_causality</th>
<th align="right">needs</th>
<th align="right">wellbeing</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">-0.33</td>
<td align="right">-1.18</td>
<td align="right">0.16</td>
<td align="right">0.12</td>
<td align="right">-1.04</td>
<td align="right">0.78</td>
<td align="right">-0.67</td>
</tr>
<tr class="even">
<td align="right">-0.41</td>
<td align="right">1.52</td>
<td align="right">-0.59</td>
<td align="right">-0.99</td>
<td align="right">-0.30</td>
<td align="right">-0.98</td>
<td align="right">0.41</td>
</tr>
<tr class="odd">
<td align="right">-0.48</td>
<td align="right">0.95</td>
<td align="right">-0.48</td>
<td align="right">-1.77</td>
<td align="right">0.51</td>
<td align="right">1.07</td>
<td align="right">1.77</td>
</tr>
<tr class="even">
<td align="right">-0.98</td>
<td align="right">-1.32</td>
<td align="right">1.11</td>
<td align="right">-1.16</td>
<td align="right">-1.83</td>
<td align="right">-0.02</td>
<td align="right">1.58</td>
</tr>
<tr class="odd">
<td align="right">-0.27</td>
<td align="right">-1.10</td>
<td align="right">-0.01</td>
<td align="right">-0.64</td>
<td align="right">1.28</td>
<td align="right">1.17</td>
<td align="right">0.54</td>
</tr>
</tbody>
</table>
<p>This synthetic dataset is consistent with the structure encoded in
our FAIR SDT, though the parameter values are arbitrary.</p>
<blockquote>
<p>Which of the following is <strong>not a reason</strong> to use
computational simulation studies?
<select class="webex-select"><option value="blank"></option>
<option value="">Exploring
what-if scenarios</option>
<option value="answer">Fitting a model to
real-world data</option>
<option value="">Preregistering a reproducible
analysis pipeline</option>
<option value="">Conducting power
analysis</option></select></p>
</blockquote>
<div class="section level4">
<h4 id="simplifying-the-model">Simplifying the Model<a class="anchor" aria-label="anchor" href="#simplifying-the-model"></a>
</h4>
<p>Suppose we are interested in studying the effect of intrinsic
motivation on well-being. Even if our research is grounded in SDT, we do
not need the entire theory to hypothesize about this specific
relationship. We can use the DAG to derive a restricted version of the
theory that includes all variables that might confound the relationship
of interest between intrinsic motivation and well-being:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdt_pruned</span> <span class="op">&lt;-</span> <span class="fu">theorytools</span><span class="fu">:::</span><span class="fu"><a href="../reference/prune_dag.html">prune_dag</a></span><span class="op">(</span><span class="va">sdt</span>,</span>
<span>                                      exposure <span class="op">=</span> <span class="st">"intrinsic_motivation"</span>,</span>
<span>                                      outcome <span class="op">=</span> <span class="st">"wellbeing"</span><span class="op">)</span></span>
<span><span class="va">sdt_pruned</span></span></code></pre></div>
<pre><code><span><span class="co">## dag {</span></span>
<span><span class="co">## intrinsic_motivation</span></span>
<span><span class="co">## needs</span></span>
<span><span class="co">## wellbeing</span></span>
<span><span class="co">## intrinsic_motivation -&gt; wellbeing</span></span>
<span><span class="co">## needs -&gt; intrinsic_motivation</span></span>
<span><span class="co">## needs -&gt; wellbeing</span></span>
<span><span class="co">## }</span></span></code></pre>
<p>We can now generate a synthetic dataset based on this simplified
DAG:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">theorytools</span><span class="fu">::</span><span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span><span class="va">sdt_pruned</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">intrinsic_motivation</th>
<th align="right">needs</th>
<th align="right">wellbeing</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">-0.81</td>
<td align="right">-0.33</td>
<td align="right">-1.19</td>
</tr>
<tr class="even">
<td align="right">-1.22</td>
<td align="right">-0.41</td>
<td align="right">-1.90</td>
</tr>
<tr class="odd">
<td align="right">-0.49</td>
<td align="right">-0.48</td>
<td align="right">0.22</td>
</tr>
<tr class="even">
<td align="right">0.28</td>
<td align="right">-0.98</td>
<td align="right">1.25</td>
</tr>
<tr class="odd">
<td align="right">0.82</td>
<td align="right">-0.27</td>
<td align="right">0.34</td>
</tr>
<tr class="even">
<td align="right">0.59</td>
<td align="right">-1.01</td>
<td align="right">-1.17</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level3">
<h3 id="analyze-the-simulated-data">5. Analyze the Simulated Data<a class="anchor" aria-label="anchor" href="#analyze-the-simulated-data"></a>
</h3>
<p>If our goal is to conduct a computational study, we can manipulate
any aspect of the data simulation procedure. These manipulations are the
independent variables of our computational study. We can then apply any
kind of analysis to the simulated data to obtain the outcome (dependent
variable) of our computational study.</p>
<p>One of the most basic types of computational simulation studies is a
power analysis, where we manipulate the true effect size of a parameter
(independent variable: effect size) and calculate whether or not we
observe a significant result for a test of that parameter in the
simulated data (dependent variable: significance).</p>
<p>The analysis function in this case would be a simple significance
test of the parameter of interest. First, we conduct bivariate linear
regression (because the DAG indicated that we need to control for the
effect of needs):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">wellbeing</span> <span class="op">~</span> <span class="va">intrinsic_motivation</span> <span class="op">+</span> <span class="va">needs</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## lm(formula = wellbeing ~ intrinsic_motivation + needs, data = df)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Residuals:</span></span>
<span><span class="co">##      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">## -2.93688 -0.87862 -0.03086  0.74147  2.56125 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##                      Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)          -0.02492    0.11579  -0.215 0.830069    </span></span>
<span><span class="co">## intrinsic_motivation  0.44496    0.11522   3.862 0.000203 ***</span></span>
<span><span class="co">## needs                -0.30228    0.11815  -2.558 0.012061 *  </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Residual standard error: 1.126 on 97 degrees of freedom</span></span>
<span><span class="co">## Multiple R-squared:  0.1839, Adjusted R-squared:  0.1671 </span></span>
<span><span class="co">## F-statistic: 10.93 on 2 and 97 DF,  p-value: 5.231e-05</span></span></code></pre>
<p>Then, our outcome of interest is the significance of the effect of
<code>intrinsic_motivation</code>. We can extract the p-value as
follows, and compare it to the significance level
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>&lt;</mo><mn>.05</mn></mrow><annotation encoding="application/x-tex">\alpha &lt; .05</annotation></semantics></math>
to get a binary result (significant: TRUE or FALSE):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sum_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="va">sum_res</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">"intrinsic_motivation"</span>, <span class="st">"Pr(&gt;|t|)"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.05</span></span></code></pre></div>
<blockquote>
<p>Run the code yourself, and answer true or false: In this one dataset,
the result was significant.
<select class="webex-select"><option value="blank"></option>
<option value="answer">TRUE</option>
<option value="">FALSE</option></select></p>
</blockquote>
</div>
</div>
<div class="section level2">
<h2 id="using-worcs-with-targets-sustainable-reproducibility">Using <code>worcs</code> with <code>targets</code>: Sustainable
Reproducibility<a class="anchor" aria-label="anchor" href="#using-worcs-with-targets-sustainable-reproducibility"></a>
</h2>
<p>One of the main tenets of open and reproducible science is the
ability to re-run all analyses from raw data to published output, to
ensure that results are still valid. However, in computationally
intensive projects, re-running unchanged code repeatedly can be
redundant, slow, and wasteful.</p>
<p>The <code>targets</code> package reduces unnecessary compute by
breaking down an analysis pipeline into steps that explicitly reference
one another, where each step is only re-computed if either the step
changed, or its inputs changed. Reducing unnecessary computation speeds
up the analysis process and reduces the carbon footprint of analyses
<span class="citation">(Gupta et al. 2021)</span>.</p>
<p>By combining <code>worcs</code> with <code>targets</code>, we get the
best of both worlds:</p>
<ul>
<li>
<code>worcs</code> is used to create a fully reproducible research
archive;</li>
<li>
<code>targets</code> ensures that redundant steps in a reproducible
analysis pipeline are not unnecessarily re-computed.</li>
</ul>
<div class="section level3">
<h3 id="add-targets-to-the-worcs-project">6. Add <code>targets</code> to the WORCS Project<a class="anchor" aria-label="anchor" href="#add-targets-to-the-worcs-project"></a>
</h3>
<p><strong>Interactive:</strong> Let’s install the packages required for
this next section:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"targets"</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"tarchetypes"</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><strong>Interactive:</strong> Then, add <code>targets</code>
integration to the <code>worcs</code> project by running:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">worcs</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/worcs/reference/add_targets.html" class="external-link">add_targets</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Note the status messages. The newly created <code>_targets.R</code>
file specifies the steps in the reproducible workflow. The newly created
<code>"./R/"</code> directory should contain functions that are used in
that workflow.</p>
</div>
<div class="section level3">
<h3 id="try-running-the-pipeline">7. Try Running the Pipeline<a class="anchor" aria-label="anchor" href="#try-running-the-pipeline"></a>
</h3>
<p>Open the file <code>_targets.R</code>. Note that the default pipeline
(which will look something like the code below) consists of a few
placeholder steps:</p>
<ol style="list-style-type: decimal">
<li>Create <code>data</code>
</li>
<li>Run a <code>model</code>
</li>
<li>Render the <code>manuscript.Rmd</code>
</li>
</ol>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">data</span>,</span>
<span>    command <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">model</span>,</span>
<span>    command <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coefficients</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tarchetypes</span><span class="fu">::</span><span class="fu">tar_render</span><span class="op">(</span><span class="va">manuscript</span>, <span class="st">"manuscript/manuscript.Rmd"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Interactive:</strong> You can run this pipeline by executing
the command <code>targets::tar_make()</code>.</p>
<div class="section level4">
<h4 id="set-a-seed">Set a Seed<a class="anchor" aria-label="anchor" href="#set-a-seed"></a>
</h4>
<p>Computational simulation studies typically rely on random number
generation to repeatedly simulate a scenario with some variability.</p>
<p>This dependency on random numbers makes the results non-reproducible
(the random numbers will be different upon repeated evaluation).</p>
<p>Fortunately, true random numbers are rarely used: we typically use a
sequence of <em>pseudo</em> random numbers.</p>
<p>To make the randomness reproducible, we can set a “seed” for the
random number generator. Setting a seed essentially jumps into the
sequence of pseudo-random numbers at the same point each time, so we get
the same “random” numbers over and over.</p>
<p>To set a seed, add the command <code>set.seed(1)</code> above the
<code>targets</code> pipeline. You can use any number instead of
<code>1</code>, which will lead to different results.</p>
</div>
<div class="section level4">
<h4 id="debugging">Debugging<a class="anchor" aria-label="anchor" href="#debugging"></a>
</h4>
<p>Running <code>targets::tar_make()</code> might fail; I have observed
two modes of failure:</p>
<ol style="list-style-type: decimal">
<li>It cannot find the file at <code>../theory/sdt.txt</code>; changing
this to <code>theory/sdt.txt</code> seems to work. Perhaps
<code>targets::tar_make()</code> evaluates code chunks in the parent
directory?</li>
<li>
<code>targets::tar_make()</code> fails the first time, but succeeds
when re-running it a second time.</li>
</ol>
</div>
</div>
<div class="section level3">
<h3 id="create-your-own-functions">8. Create Your Own Functions<a class="anchor" aria-label="anchor" href="#create-your-own-functions"></a>
</h3>
<p>Now, let’s create our own functions for the steps we need in our
computational simulation study (power analysis).</p>
<div class="section level4">
<h4 id="function-to-generate-data">Function to Generate Data<a class="anchor" aria-label="anchor" href="#function-to-generate-data"></a>
</h4>
<p>First, we need a function to generate synthetic data, which allows us
to manipulate the true effect size.</p>
<p>The <code><a href="../reference/simulate_data.html">simulate_data()</a></code> function we used previously to
create a single synthetic dataset can also generate a script for
synthetic data generation:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">theorytools</span><span class="fu">::</span><span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span><span class="va">sdt_pruned</span>, n <span class="op">=</span> <span class="fl">100</span>, run <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "# Set random seed"                                                     </span></span>
<span><span class="co">##  [2] "set.seed(644938424)"                                                   </span></span>
<span><span class="co">##  [3] "# Set simulation parameters"                                           </span></span>
<span><span class="co">##  [4] "n &lt;- 100"                                                              </span></span>
<span><span class="co">##  [5] "# Simulate exogenous nodes"                                            </span></span>
<span><span class="co">##  [6] "needs &lt;- rnorm(n = n)"                                                 </span></span>
<span><span class="co">##  [7] "# Simulate endogenous nodes"                                           </span></span>
<span><span class="co">##  [8] "intrinsic_motivation &lt;- 0.16 * needs + rnorm(n = n)"                   </span></span>
<span><span class="co">##  [9] "wellbeing &lt;- 0.21 * intrinsic_motivation - 0.21 * needs + rnorm(n = n)"</span></span>
<span><span class="co">## [10] "df &lt;- data.frame("                                                     </span></span>
<span><span class="co">## [11] "intrinsic_motivation = intrinsic_motivation,"                          </span></span>
<span><span class="co">## [12] "needs = needs,"                                                        </span></span>
<span><span class="co">## [13] "wellbeing = wellbeing"                                                 </span></span>
<span><span class="co">## [14] ")"</span></span></code></pre>
<p>Let’s write this script to a new file in <code>./R/</code>, and edit
it.</p>
<p><strong>Interactive:</strong> Run the following code:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span></span>
<span>  <span class="fu">theorytools</span><span class="fu">::</span><span class="fu"><a href="../reference/simulate_data.html">simulate_data</a></span><span class="op">(</span><span class="va">sdt_pruned</span>, n <span class="op">=</span> <span class="fl">100</span>, run <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="st">"R/generate_data.R"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Open the file <code>R/generate_data.R</code>, and edit it as follows
(or in any other way you please):</p>
<ul>
<li>Wrap the code in a <code>fuction()</code> call with arguments
<code>beta, n</code>
</li>
<li>Comment out the random seed, so that each run will be different</li>
<li>Comment out <code>n &lt;- 100</code> so that <code>n</code> is
controlled via the function arguments</li>
<li>Replace the fixed effect size for <code>intrinsic_motivation</code>
with the argument <code>beta</code>, so that effect size is controlled
via the function arguments</li>
</ul>
<pre><code><span><span class="va">generate_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">beta</span>, <span class="va">n</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="co"># Set random seed</span></span>
<span><span class="co"># set.seed(442008606)</span></span>
<span><span class="co"># Set simulation parameters</span></span>
<span><span class="co"># n &lt;- 100</span></span>
<span><span class="co"># Simulate exogenous nodes</span></span>
<span><span class="va">needs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="co"># Simulate endogenous nodes</span></span>
<span><span class="va">intrinsic_motivation</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="op">(</span><span class="fl">0.19</span> <span class="op">*</span> <span class="va">needs</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">wellbeing</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">intrinsic_motivation</span> <span class="op">-</span> <span class="fl">0.42</span> <span class="op">*</span> <span class="va">needs</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>intrinsic_motivation <span class="op">=</span> <span class="va">intrinsic_motivation</span>,</span>
<span>needs <span class="op">=</span> <span class="va">needs</span>,</span>
<span>wellbeing <span class="op">=</span> <span class="va">wellbeing</span></span>
<span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="optional-the-effect-of-needs">
<em>Optional</em>: The Effect of Needs<a class="anchor" aria-label="anchor" href="#optional-the-effect-of-needs"></a>
</h4>
<p>Note that the effect of <code>needs</code> on
<code>intrinsic_motivation</code> and <code>wellbeing</code> is
hard-coded in the code snippet above. It is possible to draw a random
value for these effects each time. To do so, you could (for example)
replace the fixed values with
<code>runif(1, min = -.4, max = .4)</code>.</p>
</div>
<div class="section level4">
<h4 id="function-to-analyze-data">Function to Analyze Data<a class="anchor" aria-label="anchor" href="#function-to-analyze-data"></a>
</h4>
<p>Now, create another file called <code>analyze_data.R</code> to
contain a function to perform the analysis procedure we defined in step
5:</p>
<pre><code><span><span class="va">analyze_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">{</span></span>
<span><span class="co"># Conduct linear regression</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">wellbeing</span> <span class="op">~</span> <span class="va">intrinsic_motivation</span> <span class="op">+</span> <span class="va">needs</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span><span class="co"># Obtain a model summary</span></span>
<span><span class="va">sum_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co"># Compare p-value of our coefficient of interest to the significance level, .05</span></span>
<span><span class="va">sum_res</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="st">"intrinsic_motivation"</span>, <span class="st">"Pr(&gt;|t|)"</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.05</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="function-to-conduct-the-study">Function to Conduct the Study<a class="anchor" aria-label="anchor" href="#function-to-conduct-the-study"></a>
</h4>
<p>We will also need a function to conduct the computational simulation
study itself. Create a file called <code>perform_study.R</code>,
containing a function like this (feel free to develop your own):</p>
<pre><code><span><span class="va">perform_study</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_design</span>, <span class="va">reps</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># For each row of the study design, execute a function</span></span>
<span>  <span class="va">pwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">study_design</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">thisrow</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Replicate the row of the study design reps times</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">reps</span>, expr <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># Simulate data with the beta and n from thisrow</span></span>
<span>      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">thisrow</span><span class="op">)</span>, <span class="fu">generate_data</span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, n <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="co"># Analyze those data</span></span>
<span>      <span class="fu">analyze_data</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="co"># Calculate the proportion of significant results using mean()</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co"># Make a data frame containing the study design and study results (pwr)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">study_design</span>, power <span class="op">=</span> <span class="va">pwr</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="create-your-own-pipeline">9. Create Your Own Pipeline<a class="anchor" aria-label="anchor" href="#create-your-own-pipeline"></a>
</h3>
<p>In the file <code>_targets.R</code>, we can now define our own
pipeline for our computational simulation study.</p>
<p>For each step in the pipeline, we define a <code>tar_target()</code>,
naming the output with <code>name</code>.</p>
<p>Our goal is to create a list that looks something like this:</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">study_design</span>,</span>
<span>    command <span class="op">=</span> <span class="va">...</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">study_results</span>,</span>
<span>    command <span class="op">=</span> <span class="va">...</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu">tarchetypes</span><span class="fu">::</span><span class="fu">tar_render</span><span class="op">(</span><span class="va">manuscript</span>, <span class="st">"manuscript/manuscript.Rmd"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<div class="section level4">
<h4 id="create-study-design">Create Study Design<a class="anchor" aria-label="anchor" href="#create-study-design"></a>
</h4>
<p>For a power analysis, we can manipulate the true effect size and
sample size.</p>
<p>Let’s say we want to design a study where the true effect size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>.1</mn><mo>,</mo><mn>.2</mn><mo>,</mo><mn>.4</mn><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">\beta \in [.1, .2, .4]</annotation></semantics></math>
and the sample size
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>∈</mo><mrow><mo stretchy="true" form="prefix">[</mo><mn>50</mn><mo>,</mo><mn>100</mn><mo>,</mo><mn>200</mn><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">n \in [50, 100, 200]</annotation></semantics></math>
(for convenience’s sake, we omit an analysis of false-positive results
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\beta = 0</annotation></semantics></math>
now).</p>
<p>We can use the R-function <code><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid()</a></code> to create all
possible combinations:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.2</span>, <span class="fl">.4</span><span class="op">)</span>,</span>
<span>  n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   beta   n</span></span>
<span><span class="co">## 1  0.1  50</span></span>
<span><span class="co">## 2  0.2  50</span></span>
<span><span class="co">## 3  0.4  50</span></span>
<span><span class="co">## 4  0.1 100</span></span>
<span><span class="co">## 5  0.2 100</span></span>
<span><span class="co">## 6  0.4 100</span></span>
<span><span class="co">## 7  0.1 200</span></span>
<span><span class="co">## 8  0.2 200</span></span>
<span><span class="co">## 9  0.4 200</span></span></code></pre>
<p>Add this to the pipeline as follows:</p>
<pre><code><span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">study_design</span>,</span>
<span>    command <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.1</span>, <span class="fl">.2</span>, <span class="fl">.4</span><span class="op">)</span>,</span>
<span>      n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre>
<p>Now, add another target to conduct the study, based on
<code>study_design</code>. Explicitly referencing an object with this
<code>name</code> will ensure that the code is re-run if
<code>study_design</code> changes (verify this yourself).</p>
<pre><code><span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>    name <span class="op">=</span> <span class="va">study_results</span>,</span>
<span>    command <span class="op">=</span> <span class="fu">perform_study</span><span class="op">(</span>study_design <span class="op">=</span> <span class="va">study_design</span>, reps <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="edit-manuscript-rmd">10. Edit <code>manuscript.Rmd</code><a class="anchor" aria-label="anchor" href="#edit-manuscript-rmd"></a>
</h3>
<p>Now, open <code>manuscript.Rmd</code> and edit it to load
<code>study_results</code> and tabulate or plot them. To load the study
results, replace the default line <code>tar_load(model)</code> (from the
mock pipeline created earlier) with
<code>tar_load(study_results)</code>. Using <code>tar_load()</code>
inside of <code>manuscript.Rmd</code> makes the latter dependent on the
former. Thus, if <code>study_results</code> changes, the manuscript
should be automatically re-run.</p>
<p><strong>Interactive:</strong> To verify that the interdependencies
between pipeline steps are properly tracked, you can run:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"visNetwork"</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_visnetwork</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="visnetwork.png"><!-- --></p>
<p>Add the following code to the manuscript to tabulate the results:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">study_results</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">beta</th>
<th align="right">n</th>
<th align="right">power</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.0</td>
<td align="right">50</td>
<td align="right">0.09</td>
</tr>
<tr class="even">
<td align="right">0.2</td>
<td align="right">50</td>
<td align="right">0.22</td>
</tr>
<tr class="odd">
<td align="right">0.4</td>
<td align="right">50</td>
<td align="right">0.77</td>
</tr>
<tr class="even">
<td align="right">0.0</td>
<td align="right">100</td>
<td align="right">0.06</td>
</tr>
<tr class="odd">
<td align="right">0.2</td>
<td align="right">100</td>
<td align="right">0.56</td>
</tr>
<tr class="even">
<td align="right">0.4</td>
<td align="right">100</td>
<td align="right">0.98</td>
</tr>
<tr class="odd">
<td align="right">0.0</td>
<td align="right">200</td>
<td align="right">0.03</td>
</tr>
<tr class="even">
<td align="right">0.2</td>
<td align="right">200</td>
<td align="right">0.74</td>
</tr>
<tr class="odd">
<td align="right">0.4</td>
<td align="right">200</td>
<td align="right">1.00</td>
</tr>
</tbody>
</table>
<p>Or alternatively, add the following code to plot the study results
(this requires running
<code>install.packages("ggplot2", prompt = FALSE)</code>).</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">df_plot</span> <span class="op">&lt;-</span> <span class="va">study_results</span></span>
<span><span class="va">df_plot</span><span class="op">$</span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">ordered</a></span><span class="op">(</span><span class="va">df_plot</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df_plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">power</span>, color <span class="op">=</span> <span class="va">beta</span>, shape <span class="op">=</span> <span class="va">beta</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="computational_social_science_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="run-the-pipeline">11. Run the Pipeline<a class="anchor" aria-label="anchor" href="#run-the-pipeline"></a>
</h3>
<p><strong>Interactive:</strong> If you were successful, you should be
able to run the pipeline by calling
<code>targets::tar_make()</code>.</p>
</div>
<div class="section level3">
<h3 id="add-endpoints">12. Add Endpoints<a class="anchor" aria-label="anchor" href="#add-endpoints"></a>
</h3>
<p>The <code>worcs</code> package allows you to specify endpoints for
your analysis; this makes it possible to check whether analysis results
are identical upon repeated evaluation.</p>
<p>If your analysis is/should be fully deterministic, with any random
numbers controlled by <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> to ensure identical
results upon repeated evaluation, then it’s possible to specify the
entire output document (e.g., <code>manuscript.html</code>) as an
endpoint.</p>
<p>Alternatively, if your document does depend non-deterministically on
random numbers (e.g., you plot the results with some random jitter),
then it cannot be exactly reproduced. In this case, you can either
remove all non-deterministic sources of randomness, or simply track
deterministic intermediate outputs as endpoints. For example, you could
write the analysis results to a <code>.csv</code> file, and track that
as an endpoint.</p>
<p>You can add an endpoint by calling
<code>worcs::add_endpoint("manuscript/manuscript.html")</code>. If the
endpoint is intentionally changed (e.g., because you updated your
analysis code), you can update its record by calling
<code><a href="https://cjvanlissa.github.io/worcs/reference/snapshot_endpoints.html" class="external-link">worcs::snapshot_endpoints()</a></code>.</p>
<p>You can call <code><a href="https://cjvanlissa.github.io/worcs/reference/reproduce.html" class="external-link">worcs::reproduce()</a></code>, which (in a project
with <code>targets</code>) calls <code>tar_make()</code> and then calls
<code><a href="https://cjvanlissa.github.io/worcs/reference/check_endpoints.html" class="external-link">worcs::check_endpoints()</a></code> to verify that the endpoints
reproduce after re-running the analysis.</p>
<p>Be very mindful of the fact that <code>targets</code> does not re-run
pipeline steps when the step, or the inputs of the step, have not
changed. That means that it might look like your code reproduces upon
repeat evaluation - but only because the code was not actually
re-evaluated, because <code>targets</code> retrieved the results from
its cache.</p>
<p>To properly evaluate whether your code reproduces, you must first
destroy the cache of pipeline results before running
<code><a href="https://cjvanlissa.github.io/worcs/reference/reproduce.html" class="external-link">worcs::reproduce()</a></code>. That causes targets to re-run every
step of the pipeline. This might look like:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Snapshot the current state of the endpoints</span></span>
<span><span class="fu">worcs</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/worcs/reference/snapshot_endpoints.html" class="external-link">snapshot_endpoints</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Destroy the cache of targets results</span></span>
<span><span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_destroy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># worcs::reproduce() calls targets::tar_make(), then worcs::check_endpoints()</span></span>
<span><span class="fu">worcs</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/worcs/reference/reproduce.html" class="external-link">reproduce</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="optional-use-parallel-computation">
<em>Optional:</em> Use Parallel Computation<a class="anchor" aria-label="anchor" href="#optional-use-parallel-computation"></a>
</h2>
<p>Computational studies, like power analyses via Monte Carlo
simulation, often require repeating computations many times, which can
be time-consuming. Modern computers (CPUs) usually have multiple
“cores”; by default, a program like Rstudio uses one core - but it’s
possible to assign a task to multiple cores. Parallel computing is the
practice of distributing a computational task across multiple CPU cores,
significantly speeding up execution.</p>
<p>In this section, you’ll learn how to parallelize your simulation
study using the <code>future</code> package. This package has a simple
interface and can be implemented in your <code>perform_study()</code>
function with minimal code changes.</p>
<div class="section level3">
<h3 id="install-and-load-required-packages">1. Install and Load Required Packages<a class="anchor" aria-label="anchor" href="#install-and-load-required-packages"></a>
</h3>
<p>There are various ways to implement parallel computing, and some
methods are specific to different operating systems. The method below
works (at least) on Windows.</p>
<p><strong>Interactive:</strong> First, install the required
packages:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"future"</span>, prompt <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="adding-paralellization-to-perform_study">2. Adding Paralellization to <code>perform_study()</code><a class="anchor" aria-label="anchor" href="#adding-paralellization-to-perform_study"></a>
</h3>
<p>Paralellization in R requires registering a parallel backend:
essentially, starting an R-session on each of the cores you want to use,
and loading the required functions and packages there. These cores do
not have access to the main R-session you are using interactively; they
do not see what variables and functions you have loaded.</p>
<p>To register a parallel backend, you can add the following code to
<code>perform_study()</code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span></code></pre></div>
<p>Instead of hard-coding the number of workers (cores) to
<code>4L</code> (integer 4), you should choose the number based on your
computer’s actual number of cores. You can determine the number of cores
by running <code><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">parallelly::availableCores()</a></code>. While you can use
all cores for parallel computing, people often use one or two fewer so
they can keep using their computer while the simulation is running.</p>
<p>To do so, you could adapt the code as follows:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">2L</span><span class="op">)</span></span></code></pre></div>
<p>Note that on Mac or Linux, you might be able to use a more efficient
backend by ‘forking’ processes. To do so, use
<code>plan(multicore)</code> instead of
<code>plan(multisession)</code>.</p>
<p>The package <code>future.apply</code> contains parallel equivalents
to base R functions like <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply()</a></code>, <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply()</a></code>,
and importantly, <code><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate()</a></code>. To paralellize the inner loop
of our simulation, we can use:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">reps</span>, expr <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">thisrow</span><span class="op">)</span>, <span class="fu">generate_data</span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, n <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">analyze_data</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    future.seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The argument <code>future.seed</code> ensures that random seeds are
properly handled so the results will be replicable. For more information
on seeds in parallel computation, see <a href="https://www.jottr.org/2020/09/22/push-for-statistical-sound-rng/" class="external-link">this
blog post</a>.</p>
<div class="section level4">
<h4 id="what-to-paralellize">What to Paralellize?<a class="anchor" aria-label="anchor" href="#what-to-paralellize"></a>
</h4>
<p>Computational simulation studies often consist of loops-within-loops.
Deciding <em>which loop</em> to paralellize is a bit of an art form, and
an area of specialization. Considerations that weigh in to the decision
are:</p>
<ul>
<li>What is the overhead (in terms of processing time) to set up the
parallel backend?</li>
<li>Where is the bottleneck: does the simulation fill up working memory,
or does it max out your processor? You can <a href="https://adv-r.hadley.nz/perf-measure.html" class="external-link">use code profiling</a>
to assess CPU and memory bottlenecks, but this is beyond the scope of
the present tutorial.</li>
</ul>
<p>In this case, we could paralellize across the 9 conditions of the
study, or across the 100 replications of those conditions. I chose to
paralellize across the 9 study conditions, having each core execute one
condition 100 times. Compare the function <code>perform_study()</code>
with and without paralellization:</p>
<div class="section level5">
<h5 id="without-paralellization">Without Paralellization<a class="anchor" aria-label="anchor" href="#without-paralellization"></a>
</h5>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perform_study</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_design</span>, <span class="va">reps</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># For each row of the study design, execute a function</span></span>
<span>  <span class="va">pwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">study_design</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">thisrow</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Replicate the row of the study design reps times</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">reps</span>, expr <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># Simulate data with the beta and n from thisrow</span></span>
<span>      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">thisrow</span><span class="op">)</span>, <span class="fu">generate_data</span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, n <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="co"># Analyze those data</span></span>
<span>      <span class="fu">analyze_data</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="co"># Calculate the proportion of significant results using mean()</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co"># Make a data frame containing the study design and study results (pwr)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">study_design</span>, power <span class="op">=</span> <span class="va">pwr</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="with-paralellization">With Paralellization<a class="anchor" aria-label="anchor" href="#with-paralellization"></a>
</h5>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perform_study</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_design</span>, <span class="va">reps</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span>  <span class="co"># Sets up clusters from number of cores</span></span>
<span>  <span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="fl">2L</span><span class="op">)</span></span>
<span>  <span class="va">pwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">study_design</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">thisrow</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Replicate the row of the study design reps times</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">future.apply</span><span class="fu">::</span><span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_replicate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">reps</span>, expr <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="co"># Simulate data with the beta and n from thisrow</span></span>
<span>      <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">thisrow</span><span class="op">)</span>, <span class="fu">generate_data</span><span class="op">(</span>beta <span class="op">=</span> <span class="va">beta</span>, n <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="co"># Analyze those data</span></span>
<span>      <span class="fu">analyze_data</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    future.seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="co"># Calculate the proportion of significant results using mean()</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">study_design</span>, power <span class="op">=</span> <span class="va">pwr</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level4">
<h4 id="re-run-the-pipeline">3. Re-run the Pipeline<a class="anchor" aria-label="anchor" href="#re-run-the-pipeline"></a>
</h4>
<p>Now rerun your simulation with:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">targets</span><span class="fu">::</span><span class="fu">tar_make</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Do you notice a speedup? Probably not, because the overhead
associated with setting up the parallel back-end outweighs the time
saved by paralellization. When you are running many repetitions or
conducting large computational simulation studies, there will be time
saved. You can <a href="https://www.alexejgossmann.com/benchmarking_r/" class="external-link">benchmark your
code</a> to estimate how much time will be saved (but this is beyond the
scope of the present tutorial).</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="optional-add-integration-tests">
<em>Optional:</em> Add Integration Tests<a class="anchor" aria-label="anchor" href="#optional-add-integration-tests"></a>
</h2>
<p>Integration testing is a procedure used in software development to
ensure that your code works as expected. In a WORCS project, using
integration tests increases scientific rigor and helps you ensure
reproducibility. This section explains the bare basics of integration
testing for reproducible research workflows; see the <a href="https://r-pkgs.org/testing-basics.html" class="external-link">R Packages book</a> for
more detail.</p>
<div class="section level4">
<h4 id="why-write-tests">Why Write Tests?<a class="anchor" aria-label="anchor" href="#why-write-tests"></a>
</h4>
<p>You probably already test your functions informally - you write a
function, run it in the console, and see if the output looks good. This
is better than nothing - but is it fool-proof? Will you remember which
functions looked good in 6 months? What if someone changes part of your
code? What if functions are used in a different way then you
expected?</p>
<p><strong>Integration tests:</strong></p>
<ul>
<li>Run automatically and consistently.</li>
<li>Help catch bugs.</li>
<li>Provide documentation of expected behavior.</li>
<li>Encourage modular, testable code.</li>
</ul>
</div>
<div class="section level4">
<h4 id="when-to-test">When to Test?<a class="anchor" aria-label="anchor" href="#when-to-test"></a>
</h4>
<ul>
<li>When you write a new function.</li>
<li>When fixing a bug (add a test to catch it next time).</li>
<li>Before sharing, submitting, or publishing your analysis.</li>
</ul>
</div>
<div class="section level3">
<h3 id="set-up-testthat">1. Set Up <code>testthat</code><a class="anchor" aria-label="anchor" href="#set-up-testthat"></a>
</h3>
<p><strong>Interactive</strong>: In your WORCS project, run the
following code:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">worcs</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/worcs/reference/add_testthat.html" class="external-link">add_testthat</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This creates a <code>tests/testthat/</code> folder to hold your
tests. Note the two suggestions printed in the console:</p>
<ul>
<li>Run <code><a href="https://usethis.r-lib.org/reference/use_r.html" class="external-link">usethis::use_test()</a></code> to initialize a basic test file
and open it for editing.</li>
<li>Run <code><a href="https://cjvanlissa.github.io/worcs/reference/github_action_check_endpoints.html" class="external-link">worcs::github_action_testthat()</a></code> to add a GitHub
action that evaluates the integration tests.</li>
</ul>
</div>
<div class="section level3">
<h3 id="write-a-simple-test">2. Write a Simple Test<a class="anchor" aria-label="anchor" href="#write-a-simple-test"></a>
</h3>
<p>Let’s prepare a file to test the behavior of our function
<code>generate_data()</code> by running
<code>usethis::use_test(name = "generate_data")</code>.</p>
<p>By default, the test file should look like this, testing some common
sense math:</p>
<pre><code><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"multiplication works"</span>, <span class="op">{</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre>
<p>Each test file contains:</p>
<ul>
<li>A function call to <code>test_that()</code>
</li>
<li>A short description, in this case
<code>"multiplication works"</code>.</li>
<li>One or more <strong>expectations</strong> that are evaluated, like
<code>expect_equal()</code> in the example above.</li>
</ul>
<p>Test files’ names must start with <code>test-</code>, and they must
be saved in <code>tests/testthat/</code>.</p>
</div>
<div class="section level3">
<h3 id="run-tests">3. Run Tests<a class="anchor" aria-label="anchor" href="#run-tests"></a>
</h3>
<p>In your console or script, you can run:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">worcs</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/worcs/reference/add_testthat.html" class="external-link">test_worcs</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Or, to test a single file:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/test_file.html" class="external-link">test_file</a></span><span class="op">(</span><span class="st">"tests/testthat/test-generate_data.R"</span><span class="op">)</span></span></code></pre></div>
<p>The output should tell you which tests passed or failed, and why they
failed.</p>
</div>
<div class="section level3">
<h3 id="customize-your-test">4. Customize Your Test<a class="anchor" aria-label="anchor" href="#customize-your-test"></a>
</h3>
<p>What do we want to test about <code>generate_data()</code>?</p>
<p>It’s up to you, but consider testing any assumptions you make about
the function, for example:</p>
<ul>
<li>It generates a <code>data.frame</code>
</li>
<li>All columns are <code>numeric</code>
</li>
<li>The number of rows corresponds to <code>n</code>
</li>
<li>The number of columns corresponds to the number of variables in the
DAG (not tested below)</li>
<li>At a very high sample size <code>n</code>, the regression
coefficient of <code>intrinsic_motivation -&gt; wellbeing</code>
approaches <code>beta</code> within a certain tolerance</li>
</ul>
<p>What would these assumptions look like when tested? For example,
like:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"generate_data works"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Run generate_data()</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">generate_data</span><span class="op">(</span><span class="fl">.4</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="co"># It generates a `data.frame`</span></span>
<span>  <span class="fu">expect_s3_class</span><span class="op">(</span><span class="va">df</span>, <span class="st">"data.frame"</span><span class="op">)</span></span>
<span>  <span class="co"># All columns are `numeric`</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">inherits</span>, what <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># The number of rows corresponds to `n`</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">==</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="co"># At high n, the regression coefficient approaches beta within tolerance</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">generate_data</span><span class="op">(</span><span class="fl">.4</span>, <span class="fl">100000</span><span class="op">)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">wellbeing</span> <span class="op">~</span> <span class="va">intrinsic_motivation</span> <span class="op">+</span> <span class="va">needs</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equivalent</span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">.4</span>, tolerance <span class="op">=</span> <span class="fl">.01</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Copy-paste any of these tests, or write your own. Note that, instead
of grouping all tests, you could also break them up into separate
<code>test_that()</code> commands:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"generate_data generates a data.frame"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Run generate_data()</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">generate_data</span><span class="op">(</span><span class="fl">.4</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="co"># It generates a `data.frame`</span></span>
<span>  <span class="fu">expect_s3_class</span><span class="op">(</span><span class="va">df</span>, <span class="st">"data.frame"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"generate_data returns all numeric columns"</span>, <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">generate_data</span><span class="op">(</span><span class="fl">.4</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="fu">expect_true</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">inherits</span>, what <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The main advantage of this style is that the output of
<code><a href="https://testthat.r-lib.org/reference/test_dir.html" class="external-link">testthat::test_dir()</a></code> will be documented at a more
fine-grained level.</p>
</div>
<div class="section level3">
<h3 id="run-your-tests-online">5. Run your Tests Online<a class="anchor" aria-label="anchor" href="#run-your-tests-online"></a>
</h3>
<p>The development platform ‘GitHub’ allows you to run code in the cloud
(= on their servers). This is very useful when checking if your
<code>worcs</code> project reproduces on a different system from your
own, and also, to run your integration tests on a different system.</p>
<p>Doing so avoids the famous meme:</p>
<pre><code>It works on my machine ¯\_(ツ)_/¯</code></pre>
<p>GitHub Actions is an automation tool offered by GitHub, which allows
developers to run workflows directly from their repositories. By using
GitHub Actions, we can automate processes such as continuous
integration, continuous deployment, testing, and code reviews.</p>
<p>GitHub Actions are triggered by events - for example, when pushing
code updates to GitHub.</p>
<p><strong>Interactive:</strong> Let’s set up a GitHub action to run our
integration tests:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add the appropriate GitHub action:</span></span>
<span><span class="fu">worcs</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/worcs/reference/github_action_check_endpoints.html" class="external-link">github_action_testthat</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Interactive:</strong> The virtual computer environment on
GitHub actions will attempt to recreate your local environment based on
the <code>renv</code> dependency manager. To ensure that your
<code>renv</code> records are up to date, run the code below. It is
important to always snapshot your dependencies before reproducing your
analyses on another system; so run <code><a href="https://rstudio.github.io/renv/reference/snapshot.html" class="external-link">renv::snapshot()</a></code> before
publishing your code, before triggering a GitHub action, before sharing
your code with a collaborator, et cetera.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">renv</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/renv/reference/snapshot.html" class="external-link">snapshot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><strong>Interactive:</strong> Now, push your code to GitHub. Among
the files that will be updated are instructions for GitHub actions in
the <code>.github/</code> folder, and your updated
<code>renv.lock</code> file.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">worcs</span><span class="fu">::</span><span class="fu"><a href="https://cjvanlissa.github.io/worcs/reference/git_update.html" class="external-link">git_update</a></span><span class="op">(</span><span class="st">"add testthat"</span><span class="op">)</span></span></code></pre></div>
<p>Since this GitHub action is triggered by pushing code to GitHub, if
you now navigate to your GitHub repository. If you don’t remember your
GitHub URL, run:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/browseURL.html" class="external-link">browseURL</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".git"</span>, <span class="st">"/actions"</span>, <span class="fu">gert</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/gert/reference/git_remote.html" class="external-link">git_remote_list</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">url</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You should see the action running. If all is good, it will show you a
green dot (red if there are errors).</p>
<p>Integration testing gives you peace of mind - you know that your code
works as expected, and via GitHub actions, can show it to the world
too.</p>
</div>
<div class="section level3">
<h3 id="reproducing-your-analysis-online">6. Reproducing your Analysis Online<a class="anchor" aria-label="anchor" href="#reproducing-your-analysis-online"></a>
</h3>
<p>The <code>worcs</code> package also includes functionality to
reproduce your entire analysis online via GitHub actions. However,
running a full simulation study is probably not fair use of GitHub’s
servers, and might raise some eyebrows.</p>
<p>For other, smaller scale studies, <a href="https://cjvanlissa.github.io/worcs/articles/endpoints.html" class="external-link">the
vignette on endpoints</a> explains how to create a GitHub action to
reproduce your analyses in the cloud.</p>
</div>
</div>
<div class="section level2">
<h2 id="additional-resources">Additional Resources<a class="anchor" aria-label="anchor" href="#additional-resources"></a>
</h2>
<ul>
<li><a href="https://cjvanlissa.github.io/worcs/articles/targets.html" class="external-link">Using
targets to Reduce Redundant Computations</a></li>
<li><a href="https://cjvanlissa.github.io/worcs/" class="external-link">WORCS
documentation</a></li>
<li><a href="https://cjvanlissa.github.io/theorytools/">theorytools
documentation</a></li>
<li><a href="https://www.go-fair.org/fair-principles/" class="external-link">FAIR
Principles</a></li>
<li><a href="https://www.cos.io/initiatives/top-guidelines" class="external-link">TOP
Guidelines</a></li>
<li><a href="https://computing.stat.berkeley.edu/tutorial-dask-future/R-future.html" class="external-link">Paralellizing
your Code</a></li>
</ul>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-deciSelfDeterminationTheory2012" class="csl-entry">
Deci, Edward L., and Richard M. Ryan. 2012.
<span>“Self-<span>Determination Theory</span>.”</span> In <em>Handbook
of <span>Theories</span> of <span>Social Psychology</span>:
<span>Volume</span> 1</em>, edited by Paul A. M. Van Lange, Arie
W.Kruglanski, and E. ToryHiggins, 416–37. SAGE Publications Ltd. <a href="https://doi.org/10.4135/9781446249215" class="external-link">https://doi.org/10.4135/9781446249215</a>.
</div>
<div id="ref-guptaChasingCarbonElusive2021" class="csl-entry">
Gupta, Udit, Young Geun Kim, Sylvia Lee, Jordan Tse, Hsien-Hsin S. Lee,
Gu-Yeon Wei, David Brooks, and Carole-Jean Wu. 2021. <span>“Chasing
<span>Carbon</span>: <span>The Elusive Environmental Footprint</span> of
<span>Computing</span>.”</span> In <em>2021 <span>IEEE International
Symposium</span> on <span>High-Performance Computer Architecture</span>
(<span>HPCA</span>)</em>, 854–67. <a href="https://doi.org/10.1109/HPCA51647.2021.00076" class="external-link">https://doi.org/10.1109/HPCA51647.2021.00076</a>.
</div>
<div id="ref-peikertReproducibleResearchTutorial2021" class="csl-entry">
Peikert, Aaron, Caspar J. Van Lissa, and Andreas M. Brandmaier. 2021.
<span>“Reproducible <span>Research</span> in <span>R</span>: <span>A
Tutorial</span> on <span>How</span> to <span>Do</span> the <span>Same
Thing More Than Once</span>.”</span> <em>Psych</em> 3 (4): 836–67. <a href="https://doi.org/10.3390/psych3040053" class="external-link">https://doi.org/10.3390/psych3040053</a>.
</div>
<div id="ref-vanlissaComplementingPreregisteredConfirmatory2022" class="csl-entry">
Van Lissa, Caspar J. 2022. <span>“Complementing Preregistered
Confirmatory Analyses with Rigorous, Reproducible Exploration Using
Machine Learning.”</span> <em>Religion, Brain &amp; Behavior</em> 0 (0):
1–5. <a href="https://doi.org/10.1080/2153599X.2022.2070254" class="external-link">https://doi.org/10.1080/2153599X.2022.2070254</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Caspar J. Van Lissa.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
